[中文阅读](README_zh_cn.md)

# Structured Semantic Alignment Evaluation (SSAE)

The principle of SSAE is to decompose a complex Prompt into a series of fine-grained questions and require a VLM (Vision-Language Model) to answer these questions (with `Yes` or `No`). The semantic alignment of the video generated by the model is evaluated by calculating the ratio of `Yes` answers. We have organized the evaluation Prompts into six main categories and placed them in the `ssae_prompts` directory.

# Sample Script Introduction

We provide a sample script, `gemini_video_ssae.py`, which uploads videos to Google Cloud Storage and uses Gemini for automatic analysis. You can also choose to use other VLMs.

`gemini_video_ssae.py` reads the `idx` of each data entry from the question file, looks for the corresponding video `{idx}.mp4` in the local directory `{source_folder}`, uploads it to Google Cloud Storage (GCS), and then calls Gemini to analyze the video and answer all questions associated with that entry. Finally, the results are written to a JSONL output file.

## Data Flow

- **Input**: One or more question files (supporting `JSONL` or `JSON` arrays), and a local video directory.
- **Processing**:
  - Locate local video based on `idx`: `{source_folder}/{idx}.mp4`
  - Upload to GCS: `gs://{bucket}/{idx}.mp4`
  - Use Gemini to answer multiple questions regarding the video.
  - Write the result to `--output` immediately after processing each `idx`.
- **Output**: JSONL (one result object per line, including success/skipped/error status).

## Environment Setup

### 1. Install Dependencies

The script relies on the Google Cloud SDK and several Python packages:

```bash
curl https://sdk.cloud.google.com | bash
# Login and authorize full Scopes to prevent permission errors
gcloud auth application-default login 
pip install --upgrade google-cloud-storage google-genai tqdm
```

### 2. Permissions, Authentication, and Configuration Guide

This script uses Application Default Credentials (ADC) for authentication:

#### 1. Get Project ID
The Project ID is the unique identifier for all resources in GCP.

1. Log in to the Google Cloud Console and click on "Console" at the top of the page.
2. In the dialog box that appears, you will see a list of projects. Find your target project; the string listed on the right is the ID (The Project ID is usually a string like my-awesome-project-123456; do not confuse it with the Project Name).
    - *Prerequisite: The target GCP Project must have Vertex AI enabled, and the current identity must have permission to call Gemini.*

#### 2. Get Bucket Name
A Bucket is a container for storing data in GCS.

1. Go to Cloud Storage -> Buckets in the Console.
2. Create or select a bucket to get the Bucket Name.
    - *Prerequisite: The target GCS bucket must be writable by the current identity (must have object upload permission).*

## Data and File Conventions

### 1. Question File Format

The `--questions` argument accepts multiple files, and the script will merge and process them.
- Format: JSONL (Recommended) or JSON.
- Required Fields:
    - **`idx`**: Unique identifier used to associate the video `{idx}.mp4`.
    - **`questions`**: A list of questions; each element must contain at least a `question` field (string).
    - **`category`**: Optional; defaults to `"unknown"`.

### 2. Local Video Organization
The script looks for videos using the following fixed path pattern (current version only supports `.mp4`):

- Path: `{source_folder}/{idx}.mp4`
- Error: If the local video does not exist, it will be recorded as `status="skipped"` in the output JSONL.

## Usage (CLI)

```bash
# Processing a single questions file
python3 gemini_video_ssae.py \
  --project YOUR_GCP_PROJECT \
  --bucket YOUR_BUCKET \
  --source_folder ./examples \
  --questions ssae_prompts/locomotion.jsonl \
  --output analysis_results.jsonl \
  --fps 5

# Processing multiple questions files
python3 gemini_video_ssae.py \
  --project YOUR_GCP_PROJECT \
  --bucket YOUR_BUCKET \
  --source_folder ./examples \
  --questions ssae_prompts/locomotion.jsonl ssae_prompts/fitness.jsonl \
  --output analysis_results.jsonl \
  --fps 5
```

### Parameters

- **`--project`**: Google Cloud Project ID (Required).
- **`--bucket`**: GCS Bucket name for storing videos (Required).
- **`--source_folder`**: Local video folder path (Required).
- **`--questions`**: List of question file paths (Required, supports multiple).
- **`--model`**: Gemini Model ID (Default: `gemini-3-pro-preview`).
- **`--output`**: Output JSONL file path (Default: `analysis_results.jsonl`).
- **`--max_workers`**: Number of threads for parallel processing (Default: `1`).
- **`--fps`**: Specific the VideoMetadata parameter of Gemini (Default: `5`)

### Output Description (JSONL)
The output file is in JSONL format. Each line is an object roughly containing:

- Original Input Info: `idx` / `category` / `original_questions`
- Processing Status: `status`: `success` / `skipped` / `error`
- Uploaded `gcs_uri` (on success): `gs://...`
- On Success: `response` (The parsed JSON structure, including `question`, `answer`, `confidence`, and `reason`)
- On Failure: `error` (Error message string)
